<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/https-proxy-agent/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<div class="dox">
<div class="summary">
<p>Module dependencies.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> net = <span class="hljs-built_in">require</span>(<span class="hljs-string">'net'</span>);
<span class="hljs-keyword">var</span> tls = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tls'</span>);
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);
<span class="hljs-keyword">var</span> Agent = <span class="hljs-built_in">require</span>(<span class="hljs-string">'agent-base'</span>);
<span class="hljs-keyword">var</span> inherits = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>).inherits;
<span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'https-proxy-agent'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>Module exports.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = HttpsProxyAgent;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>The <code>HttpsProxyAgent</code> implements an HTTP Agent subclass that connects to the
specified &quot;HTTP(s) proxy server&quot; in order to proxy HTTPS requests.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">API</div>
<div class="dox_tag_detail">
<span class="dox_type">public</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">HttpsProxyAgent</span>(<span class="hljs-params">opts</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> HttpsProxyAgent)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpsProxyAgent(opts);
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> == <span class="hljs-keyword">typeof</span> opts) opts = url.parse(opts);
  <span class="hljs-keyword">if</span> (!opts)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
      <span class="hljs-string">'an HTTP(S) proxy server `host` and `port` must be specified!'</span>
    );
  debug(<span class="hljs-string">'creating new HttpsProxyAgent instance: %o'</span>, opts);
  Agent.call(<span class="hljs-keyword">this</span>, opts);

  <span class="hljs-keyword">var</span> proxy = <span class="hljs-built_in">Object</span>.assign({}, opts);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>if <code>true</code>, then connect to the proxy server over TLS. defaults to <code>false</code>.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.secureProxy = proxy.protocol ? <span class="hljs-regexp">/^https:?$/i</span>.test(proxy.protocol) : <span class="hljs-literal">false</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>prefer <code>hostname</code> over <code>host</code>, and set the <code>port</code> if needed</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  proxy.host = proxy.hostname || proxy.host;
  proxy.port = +proxy.port || (<span class="hljs-keyword">this</span>.secureProxy ? <span class="hljs-number">443</span> : <span class="hljs-number">80</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>ALPN is supported by Node.js &gt;= v5.
attempt to negotiate http/1.1 for proxy servers that support http/2</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.secureProxy &amp;&amp; !(<span class="hljs-string">'ALPNProtocols'</span> <span class="hljs-keyword">in</span> proxy)) {
    proxy.ALPNProtocols = [<span class="hljs-string">'http 1.1'</span>]
  }

  <span class="hljs-keyword">if</span> (proxy.host &amp;&amp; proxy.path) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>if both a <code>host</code> and <code>path</code> are specified then it's most likely the
result of a <code>url.parse()</code> call... we need to remove the <code>path</code> portion so
that <code>net.connect()</code> doesn't attempt to open that as a unix socket file.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">delete</span> proxy.path;
    <span class="hljs-keyword">delete</span> proxy.pathname;
  }

  <span class="hljs-keyword">this</span>.proxy = proxy;
  <span class="hljs-keyword">this</span>.defaultPort = <span class="hljs-number">443</span>;
}
inherits(HttpsProxyAgent, Agent);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<div class="dox">
<div class="summary">
<p>Called when the node-core HTTP client library is creating a new HTTP request.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">API</div>
<div class="dox_tag_detail">
<span class="dox_type">public</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
HttpsProxyAgent.prototype.callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connect</span>(<span class="hljs-params">req, opts, fn</span>) </span>{
  <span class="hljs-keyword">var</span> proxy = <span class="hljs-keyword">this</span>.proxy;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>create a socket connection to the proxy server</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> socket;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.secureProxy) {
    socket = tls.connect(proxy);
  } <span class="hljs-keyword">else</span> {
    socket = net.connect(proxy);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>we need to buffer any HTTP traffic that happens with the proxy before we get
the CONNECT response, so that if the response is anything other than an &quot;200&quot;
response code, then we can re-play the &quot;data&quot; events on the socket once the
HTTP parser is hooked up...</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> buffers = [];
  <span class="hljs-keyword">var</span> buffersLength = <span class="hljs-number">0</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> b = socket.read();
    <span class="hljs-keyword">if</span> (b) ondata(b);
    <span class="hljs-keyword">else</span> socket.once(<span class="hljs-string">'readable'</span>, read);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanup</span>(<span class="hljs-params"></span>) </span>{
    socket.removeListener(<span class="hljs-string">'data'</span>, ondata);
    socket.removeListener(<span class="hljs-string">'end'</span>, onend);
    socket.removeListener(<span class="hljs-string">'error'</span>, onerror);
    socket.removeListener(<span class="hljs-string">'close'</span>, onclose);
    socket.removeListener(<span class="hljs-string">'readable'</span>, read);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onclose</span>(<span class="hljs-params">err</span>) </span>{
    debug(<span class="hljs-string">'onclose had error %o'</span>, err);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onend</span>(<span class="hljs-params"></span>) </span>{
    debug(<span class="hljs-string">'onend'</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onerror</span>(<span class="hljs-params">err</span>) </span>{
    cleanup();
    fn(err);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ondata</span>(<span class="hljs-params">b</span>) </span>{
    buffers.push(b);
    buffersLength += b.length;
    <span class="hljs-keyword">var</span> buffered = Buffer.concat(buffers, buffersLength);
    <span class="hljs-keyword">var</span> str = buffered.toString(<span class="hljs-string">'ascii'</span>);

    <span class="hljs-keyword">if</span> (!~str.indexOf(<span class="hljs-string">'\r\n\r\n'</span>)) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>keep buffering</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      debug(<span class="hljs-string">'have not received end of HTTP headers yet...'</span>);
      <span class="hljs-keyword">if</span> (socket.read) {
        read();
      } <span class="hljs-keyword">else</span> {
        socket.once(<span class="hljs-string">'data'</span>, ondata);
      }
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> firstLine = str.substring(<span class="hljs-number">0</span>, str.indexOf(<span class="hljs-string">'\r\n'</span>));
    <span class="hljs-keyword">var</span> statusCode = +firstLine.split(<span class="hljs-string">' '</span>)[<span class="hljs-number">1</span>];
    debug(<span class="hljs-string">'got proxy server response: %o'</span>, firstLine);

    <span class="hljs-keyword">if</span> (<span class="hljs-number">200</span> == statusCode) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>200 Connected status code!</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">var</span> sock = socket;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>nullify the buffered data since we won't be needing it</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      buffers = buffered = <span class="hljs-literal">null</span>;

      <span class="hljs-keyword">if</span> (opts.secureEndpoint) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>since the proxy is connecting to an SSL server, we have
to upgrade this socket connection to an SSL connection</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        debug(
          <span class="hljs-string">'upgrading proxy-connected socket to TLS connection: %o'</span>,
          opts.host
        );
        opts.socket = socket;
        opts.servername = opts.servername || opts.host;
        opts.host = <span class="hljs-literal">null</span>;
        opts.hostname = <span class="hljs-literal">null</span>;
        opts.port = <span class="hljs-literal">null</span>;
        sock = tls.connect(opts);
      }

      cleanup();
      fn(<span class="hljs-literal">null</span>, sock);
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>some other status code that's not 200... need to re-play the HTTP header
&quot;data&quot; events onto the socket once the HTTP machinery is attached so that
the user can parse and handle the error status code</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      cleanup();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>save a reference to the concat'd Buffer for the <code>onsocket</code> callback</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      buffers = buffered;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>need to wait for the &quot;socket&quot; event to re-play the &quot;data&quot; events</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      req.once(<span class="hljs-string">'socket'</span>, onsocket);
      fn(<span class="hljs-literal">null</span>, socket);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onsocket</span>(<span class="hljs-params">socket</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>replay the &quot;buffers&quot; Buffer onto the <code>socket</code>, since at this point
the HTTP module machinery has been hooked up for the user</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> == <span class="hljs-keyword">typeof</span> socket.ondata) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>node &lt;= v0.11.3, the <code>ondata</code> function is set on the socket</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      socket.ondata(buffers, <span class="hljs-number">0</span>, buffers.length);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (socket.listeners(<span class="hljs-string">'data'</span>).length &gt; <span class="hljs-number">0</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>node &gt; v0.11.3, the &quot;data&quot; event is listened for directly</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      socket.emit(<span class="hljs-string">'data'</span>, buffers);
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>never?</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'should not happen...'</span>);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>nullify the cached Buffer instance</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    buffers = <span class="hljs-literal">null</span>;
  }

  socket.on(<span class="hljs-string">'error'</span>, onerror);
  socket.on(<span class="hljs-string">'close'</span>, onclose);
  socket.on(<span class="hljs-string">'end'</span>, onend);

  <span class="hljs-keyword">if</span> (socket.read) {
    read();
  } <span class="hljs-keyword">else</span> {
    socket.once(<span class="hljs-string">'data'</span>, ondata);
  }

  <span class="hljs-keyword">var</span> hostname = opts.host + <span class="hljs-string">':'</span> + opts.port;
  <span class="hljs-keyword">var</span> msg = <span class="hljs-string">'CONNECT '</span> + hostname + <span class="hljs-string">' HTTP/1.1\r\n'</span>;

  <span class="hljs-keyword">var</span> headers = <span class="hljs-built_in">Object</span>.assign({}, proxy.headers);
  <span class="hljs-keyword">if</span> (proxy.auth) {
    headers[<span class="hljs-string">'Proxy-Authorization'</span>] =
      <span class="hljs-string">'Basic '</span> + Buffer.from(proxy.auth).toString(<span class="hljs-string">'base64'</span>);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>the Host header should only include the port
number when it is a non-standard port</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> host = opts.host;
  <span class="hljs-keyword">if</span> (!isDefaultPort(opts.port, opts.secureEndpoint)) {
    host += <span class="hljs-string">':'</span> + opts.port;
  }
  headers[<span class="hljs-string">'Host'</span>] = host;

  headers[<span class="hljs-string">'Connection'</span>] = <span class="hljs-string">'close'</span>;
  <span class="hljs-built_in">Object</span>.keys(headers).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    msg += name + <span class="hljs-string">': '</span> + headers[name] + <span class="hljs-string">'\r\n'</span>;
  });

  socket.write(msg + <span class="hljs-string">'\r\n'</span>);
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isDefaultPort</span>(<span class="hljs-params">port, secure</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Boolean</span>((!secure &amp;&amp; port === <span class="hljs-number">80</span>) || (secure &amp;&amp; port === <span class="hljs-number">443</span>));
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
