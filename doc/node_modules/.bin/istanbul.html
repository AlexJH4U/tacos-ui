<!DOCTYPE html>
<html>
<head>
  <title>istanbul</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/.bin/istanbul";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>istanbul</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>Copyright (c) 2012, Yahoo! Inc.  All rights reserved.
Copyrights licensed under the New BSD License. See the accompanying LICENSE file for terms.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">

<span class="hljs-keyword">var</span> <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>),
    Command = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./command'</span>),
    inputError = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util/input-error'</span>),
    exitProcess = process.exit; <span class="hljs-comment">//hold a reference to original process.exit so that we are not affected even when a test changes it</span>

<span class="hljs-built_in">require</span>(<span class="hljs-string">'./register-plugins'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findCommandPosition</span>(<span class="hljs-params">args</span>) </span>{
    <span class="hljs-keyword">var</span> i;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; args.length; i += <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (args[i].charAt(<span class="hljs-number">0</span>) !== <span class="hljs-string">'-'</span>) {
            <span class="hljs-keyword">return</span> i;
        }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exit</span>(<span class="hljs-params">ex, code</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>flush output for Node.js Windows pipe bug
https://github.com/joyent/node/issues/6247 is just one bug example
https://github.com/visionmedia/mocha/issues/333 has a good discussion</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> streams = [process.stdout, process.stderr];
  <span class="hljs-keyword">async</span>.forEach(streams, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">stream, done</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>submit a write request and wait until it's written</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    stream.write(<span class="hljs-string">''</span>, done);
  }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (ex) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> ex === <span class="hljs-string">'string'</span>) {
            <span class="hljs-built_in">console</span>.error(ex);
            exitProcess(<span class="hljs-number">1</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> ex; <span class="hljs-comment">// turn it into an uncaught exception</span>
        }
    } <span class="hljs-keyword">else</span> {
        exitProcess(code);
    }
  });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">errHandler</span> (<span class="hljs-params">ex</span>) </span>{
    <span class="hljs-keyword">if</span> (!ex) { <span class="hljs-keyword">return</span>; }
    <span class="hljs-keyword">if</span> (!ex.inputError) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>exit with exception stack trace</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        exit(ex);
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>don't print nasty traces but still exit(1)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-built_in">console</span>.error(ex.message);
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Try "istanbul help" for usage'</span>);
        exit(<span class="hljs-literal">null</span>, <span class="hljs-number">1</span>);
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runCommand</span>(<span class="hljs-params">args, callback</span>) </span>{
    <span class="hljs-keyword">var</span> pos = findCommandPosition(args),
        command,
        commandArgs,
        commandObject;

    <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> callback(inputError.create(<span class="hljs-string">'Need a command to run'</span>));
    }

    commandArgs = args.slice(<span class="hljs-number">0</span>, pos);
    command = args[pos];
    commandArgs.push.apply(commandArgs, args.slice(pos + <span class="hljs-number">1</span>));

    <span class="hljs-keyword">try</span> {
        commandObject = Command.create(command);
    } <span class="hljs-keyword">catch</span> (ex) {
        errHandler(inputError.create(ex.message));
        <span class="hljs-keyword">return</span>;
    }
    commandObject.run(commandArgs, errHandler);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runToCompletion</span>(<span class="hljs-params">args</span>) </span>{
    runCommand(args, errHandler);
}

<span class="hljs-comment">/* istanbul ignore if: untestable */</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">require</span>.main === <span class="hljs-built_in">module</span>) {
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(process.argv, <span class="hljs-number">2</span>);
    runToCompletion(args);
}

<span class="hljs-built_in">module</span>.exports = {
    <span class="hljs-attr">runToCompletion</span>: runToCompletion
};


</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
