<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/isbinaryfile/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> alloc = <span class="hljs-built_in">require</span>(<span class="hljs-string">'buffer-alloc'</span>);
<span class="hljs-keyword">var</span> MAX_BYTES = <span class="hljs-number">512</span>;

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">bytes, size, cb</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Only two args</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (cb === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">var</span> file = bytes;
    cb = size;

    fs.stat(file, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, stat</span>) </span>{
      <span class="hljs-keyword">if</span> (err || !stat.isFile()) <span class="hljs-keyword">return</span> cb(err, <span class="hljs-literal">false</span>);

      fs.open(file, <span class="hljs-string">'r'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">r_err, descriptor</span>)</span>{
          <span class="hljs-keyword">if</span> (r_err) <span class="hljs-keyword">return</span> cb(r_err);
          bytes = alloc(MAX_BYTES);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Read the file with no encoding for raw buffer access.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          fs.read(descriptor, bytes, <span class="hljs-number">0</span>, bytes.length, <span class="hljs-number">0</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, size, bytes</span>)</span>{
            fs.close(descriptor, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c_err</span>)</span>{
                <span class="hljs-keyword">if</span> (c_err) <span class="hljs-keyword">return</span> cb(c_err, <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, isBinaryCheck(bytes, size));
            });
          });
      });
    });
  }
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, isBinaryCheck(bytes, size));
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isBinaryCheck</span>(<span class="hljs-params">bytes, size</span>) </span>{
  <span class="hljs-keyword">if</span> (size === <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">var</span> suspicious_bytes = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> total_bytes = <span class="hljs-built_in">Math</span>.min(size, MAX_BYTES);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>UTF-8 BOM</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-number">3</span> &amp;&amp; bytes[<span class="hljs-number">0</span>] == <span class="hljs-number">0xEF</span> &amp;&amp; bytes[<span class="hljs-number">1</span>] == <span class="hljs-number">0xBB</span> &amp;&amp; bytes[<span class="hljs-number">2</span>] == <span class="hljs-number">0xBF</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>UTF-32 BOM</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-number">4</span> &amp;&amp; bytes[<span class="hljs-number">0</span>] === <span class="hljs-number">0x00</span> &amp;&amp; bytes[<span class="hljs-number">1</span>] === <span class="hljs-number">0x00</span> &amp;&amp; bytes[<span class="hljs-number">2</span>] == <span class="hljs-number">0xFE</span> &amp;&amp; bytes[<span class="hljs-number">3</span>] == <span class="hljs-number">0xFF</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>UTF-32 LE BOM</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-number">4</span> &amp;&amp; bytes[<span class="hljs-number">0</span>] == <span class="hljs-number">0xFF</span> &amp;&amp; bytes[<span class="hljs-number">1</span>] == <span class="hljs-number">0xFE</span> &amp;&amp; bytes[<span class="hljs-number">2</span>] === <span class="hljs-number">0x00</span> &amp;&amp; bytes[<span class="hljs-number">3</span>] === <span class="hljs-number">0x00</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>GB BOM</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-number">4</span> &amp;&amp; bytes[<span class="hljs-number">0</span>] == <span class="hljs-number">0x84</span> &amp;&amp; bytes[<span class="hljs-number">1</span>] == <span class="hljs-number">0x31</span> &amp;&amp; bytes[<span class="hljs-number">2</span>] == <span class="hljs-number">0x95</span> &amp;&amp; bytes[<span class="hljs-number">3</span>] == <span class="hljs-number">0x33</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (total_bytes &gt;= <span class="hljs-number">5</span> &amp;&amp; bytes.slice(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>) == <span class="hljs-string">"%PDF-"</span>) {
      <span class="hljs-comment">/* PDF. This is binary. */</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>UTF-16 BE BOM</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-number">2</span> &amp;&amp; bytes[<span class="hljs-number">0</span>] == <span class="hljs-number">0xFE</span> &amp;&amp; bytes[<span class="hljs-number">1</span>] == <span class="hljs-number">0xFF</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>UTF-16 LE BOM</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-number">2</span> &amp;&amp; bytes[<span class="hljs-number">0</span>] == <span class="hljs-number">0xFF</span> &amp;&amp; bytes[<span class="hljs-number">1</span>] == <span class="hljs-number">0xFE</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; total_bytes; i++) {
    <span class="hljs-keyword">if</span> (bytes[i] === <span class="hljs-number">0</span>) { <span class="hljs-comment">// NULL byte--it's binary!</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((bytes[i] &lt; <span class="hljs-number">7</span> || bytes[i] &gt; <span class="hljs-number">14</span>) &amp;&amp; (bytes[i] &lt; <span class="hljs-number">32</span> || bytes[i] &gt; <span class="hljs-number">127</span>)) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>UTF-8 detection</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (bytes[i] &gt; <span class="hljs-number">193</span> &amp;&amp; bytes[i] &lt; <span class="hljs-number">224</span> &amp;&amp; i + <span class="hljs-number">1</span> &lt; total_bytes) {
          i++;
          <span class="hljs-keyword">if</span> (bytes[i] &gt; <span class="hljs-number">127</span> &amp;&amp; bytes[i] &lt; <span class="hljs-number">192</span>) {
            <span class="hljs-keyword">continue</span>;
          }
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bytes[i] &gt; <span class="hljs-number">223</span> &amp;&amp; bytes[i] &lt; <span class="hljs-number">240</span> &amp;&amp; i + <span class="hljs-number">2</span> &lt; total_bytes) {
          i++;
          <span class="hljs-keyword">if</span> (bytes[i] &gt; <span class="hljs-number">127</span> &amp;&amp; bytes[i] &lt; <span class="hljs-number">192</span> &amp;&amp; bytes[i + <span class="hljs-number">1</span>] &gt; <span class="hljs-number">127</span> &amp;&amp; bytes[i + <span class="hljs-number">1</span>] &lt; <span class="hljs-number">192</span>) {
            i++;
            <span class="hljs-keyword">continue</span>;
          }
      }
      suspicious_bytes++;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Read at least 32 bytes before making a decision</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">32</span> &amp;&amp; (suspicious_bytes * <span class="hljs-number">100</span>) / total_bytes &gt; <span class="hljs-number">10</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }
  }

  <span class="hljs-keyword">if</span> ((suspicious_bytes * <span class="hljs-number">100</span>) / total_bytes &gt; <span class="hljs-number">10</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-built_in">module</span>.exports.sync = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">bytes, size</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Only one arg</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (size === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">var</span> file = bytes;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span>(!fs.statSync(file).isFile()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">catch</span> (err) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>otherwise continue on</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    }
    <span class="hljs-keyword">var</span> descriptor = fs.openSync(file, <span class="hljs-string">'r'</span>);
    <span class="hljs-keyword">try</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Read the file with no encoding for raw buffer access.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      bytes = alloc(MAX_BYTES);
      size = fs.readSync(descriptor, bytes, <span class="hljs-number">0</span>, bytes.length, <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">finally</span> {
      fs.closeSync(descriptor);
    }
    <span class="hljs-keyword">return</span> isBinaryCheck(bytes, size);
  }
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> isBinaryCheck(bytes, size);
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
